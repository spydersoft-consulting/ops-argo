{{- if eq .Values.clusterName "production" }}
---
# ExternalSecret for linkerd-multicluster namespace
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: cluster-credentials-in-cluster-local-es
  namespace: linkerd-multicluster
spec:
  refreshInterval: "1h"
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: cluster-credentials-in-cluster-local
    creationPolicy: Owner
    template:
      engineVersion: v2
      type: mirror.linkerd.io/remote-kubeconfig
      data:
        kubeconfig: "{{`{{ .kubeconfig }}`}}"
  data:
    - secretKey: kubeconfig
      remoteRef:
        key: secrets-k8/linkerd-multicluster/production-to-internal
        property: kubeconfig
        conversionStrategy: Default
        decodingStrategy: None
---
# ExternalSecret for linkerd namespace (with annotations/labels)
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: cluster-credentials-in-cluster-local-linkerd-es
  namespace: linkerd-multicluster
spec:
  refreshInterval: "1h"
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: cluster-credentials-in-cluster-local-linkerd
    creationPolicy: Owner
    template:
      engineVersion: v2
      type: mirror.linkerd.io/remote-kubeconfig
      metadata:
        annotations:
          multicluster.linkerd.io/cluster-domain: cluster.local
          multicluster.linkerd.io/trust-domain: cluster.local
        labels:
          multicluster.linkerd.io/cluster-name: in-cluster-local
        namespace: linkerd
      data:
        kubeconfig: "{{`{{ .kubeconfig }}`}}"
  data:
    - secretKey: kubeconfig
      remoteRef:
        key: secrets-k8/linkerd-multicluster/production-to-internal
        property: kubeconfig
        conversionStrategy: Default
        decodingStrategy: None
{{- end }}
